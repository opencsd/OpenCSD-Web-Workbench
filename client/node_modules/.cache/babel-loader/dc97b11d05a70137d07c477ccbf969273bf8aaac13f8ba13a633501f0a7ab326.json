{"ast":null,"code":"var once = require('once');\nvar noop = function noop() {};\nvar isRequest = function isRequest(stream) {\n  return stream.setHeader && typeof stream.abort === 'function';\n};\nvar isChildProcess = function isChildProcess(stream) {\n  return stream.stdio && Array.isArray(stream.stdio) && stream.stdio.length === 3;\n};\nvar eos = function eos(stream, opts, callback) {\n  if (typeof opts === 'function') return eos(stream, null, opts);\n  if (!opts) opts = {};\n  callback = once(callback || noop);\n  var ws = stream._writableState;\n  var rs = stream._readableState;\n  var readable = opts.readable || opts.readable !== false && stream.readable;\n  var writable = opts.writable || opts.writable !== false && stream.writable;\n  var cancelled = false;\n  var onlegacyfinish = function onlegacyfinish() {\n    if (!stream.writable) onfinish();\n  };\n  var onfinish = function onfinish() {\n    writable = false;\n    if (!readable) callback.call(stream);\n  };\n  var onend = function onend() {\n    readable = false;\n    if (!writable) callback.call(stream);\n  };\n  var onexit = function onexit(exitCode) {\n    callback.call(stream, exitCode ? new Error('exited with error code: ' + exitCode) : null);\n  };\n  var onerror = function onerror(err) {\n    callback.call(stream, err);\n  };\n  var onclose = function onclose() {\n    process.nextTick(onclosenexttick);\n  };\n  var onclosenexttick = function onclosenexttick() {\n    if (cancelled) return;\n    if (readable && !(rs && rs.ended && !rs.destroyed)) return callback.call(stream, new Error('premature close'));\n    if (writable && !(ws && ws.ended && !ws.destroyed)) return callback.call(stream, new Error('premature close'));\n  };\n  var onrequest = function onrequest() {\n    stream.req.on('finish', onfinish);\n  };\n  if (isRequest(stream)) {\n    stream.on('complete', onfinish);\n    stream.on('abort', onclose);\n    if (stream.req) onrequest();else stream.on('request', onrequest);\n  } else if (writable && !ws) {\n    // legacy streams\n    stream.on('end', onlegacyfinish);\n    stream.on('close', onlegacyfinish);\n  }\n  if (isChildProcess(stream)) stream.on('exit', onexit);\n  stream.on('end', onend);\n  stream.on('finish', onfinish);\n  if (opts.error !== false) stream.on('error', onerror);\n  stream.on('close', onclose);\n  return function () {\n    cancelled = true;\n    stream.removeListener('complete', onfinish);\n    stream.removeListener('abort', onclose);\n    stream.removeListener('request', onrequest);\n    if (stream.req) stream.req.removeListener('finish', onfinish);\n    stream.removeListener('end', onlegacyfinish);\n    stream.removeListener('close', onlegacyfinish);\n    stream.removeListener('finish', onfinish);\n    stream.removeListener('exit', onexit);\n    stream.removeListener('end', onend);\n    stream.removeListener('error', onerror);\n    stream.removeListener('close', onclose);\n  };\n};\nmodule.exports = eos;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}